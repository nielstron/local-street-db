name: Deploy Web Demo

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to pull street_trie.packed.tar.xz from (leave empty for latest)"
        required: false
        default: ""

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Prepare site
        run: |
          set -euo pipefail
          mkdir -p dist
          cp -R web/* dist/

      - name: Download street_trie.packed.tar.xz from release
        env:
          REPO: ${{ github.repository }}
          TAG: ${{ inputs.release_tag }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import os
          import tarfile
          import urllib.request

          repo = os.environ["REPO"]
          tag = os.environ.get("TAG")
          token = os.environ.get("TOKEN")

          if tag:
              api_url = f"https://api.github.com/repos/{repo}/releases/tags/{tag}"
          else:
              api_url = f"https://api.github.com/repos/{repo}/releases/latest"

          req = urllib.request.Request(api_url)
          if token:
              req.add_header("Authorization", f"Bearer {token}")
          req.add_header("Accept", "application/vnd.github+json")

          with urllib.request.urlopen(req) as resp:
              data = json.loads(resp.read().decode("utf-8"))

          assets = data.get("assets", [])
          match = next((a for a in assets if a.get("name") == "street_trie.packed.tar.xz"), None)
          if not match:
              names = ", ".join(a.get("name", "") for a in assets)
              raise SystemExit(f"street_trie.packed.tar.xz not found in release assets. Available: {names}")

          download_url = match["browser_download_url"]
          out_path = os.path.join("dist", "street_trie.packed.tar.xz")
          with urllib.request.urlopen(download_url) as resp, open(out_path, "wb") as f:
              f.write(resp.read())
          print(f"Downloaded {download_url} -> {out_path}")
          with tarfile.open(out_path, "r:xz") as tf:
              tf.extractall("dist")
          shards_src = os.path.join("dist", "shards")
          shards_dst = os.path.join("dist", "build", "shards")
          if not os.path.isdir(shards_src):
              raise SystemExit(f"expected shards/ at {shards_src}")
          os.makedirs(os.path.dirname(shards_dst), exist_ok=True)
          if os.path.exists(shards_dst):
              raise SystemExit(f"destination already exists: {shards_dst}")
          os.rename(shards_src, shards_dst)
          PY

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
